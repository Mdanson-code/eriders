<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - eRdelivery</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="assets/logo.svg" alt="eRdelivery" class="h-10 mr-4">
                    <span class="font-bold text-gray-700">Admin Dashboard</span>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <span id="orderCount" class="text-xs sm:text-sm font-medium text-gray-600"></span>
                    <button onclick="refreshOrders()" class="btn btn-secondary text-xs sm:text-sm">Refresh</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card bg-blue-50">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600">Total Orders</p>
                        <p class="text-3xl font-bold" id="totalOrders">0</p>
                    </div>
                    <div class="text-4xl">üì¶</div>
                </div>
            </div>

            <div class="card bg-yellow-50">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600">Pending</p>
                        <p class="text-3xl font-bold" id="pendingOrders">0</p>
                    </div>
                    <div class="text-4xl">‚è≥</div>
                </div>
            </div>

            <div class="card bg-purple-50">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600">Active</p>
                        <p class="text-3xl font-bold" id="activeOrders">0</p>
                    </div>
                    <div class="text-4xl">üö¥</div>
                </div>
            </div>

            <div class="card bg-green-50">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600">Delivered</p>
                        <p class="text-3xl font-bold" id="deliveredOrders">0</p>
                    </div>
                    <div class="text-4xl">‚úÖ</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="searchInput" placeholder="Search by order ID or client name..." 
                       class="input" onkeyup="filterOrders()">
                
                <select id="statusFilter" class="input" onchange="filterOrders()">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="assigned">Assigned</option>
                    <option value="on_route">On Route</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>

                <select id="sortBy" class="input" onchange="filterOrders()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                </select>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="card">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                                <div class="spinner mx-auto mb-4"></div>
                                Loading orders...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">Order <span id="modalOrderId"></span></h2>
                        <p class="text-sm text-gray-600" id="modalOrderDate"></p>
                    </div>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Client Info -->
                    <div class="border-b pb-4">
                        <h3 class="font-bold mb-2">Client Information</h3>
                        <p class="text-sm"><span class="text-gray-600">Name:</span> <span id="modalClientName"></span></p>
                        <p class="text-sm"><span class="text-gray-600">WhatsApp:</span> <a href="#" id="modalClientPhone" class="text-blue-600"></a></p>
                    </div>

                    <!-- Order Details -->
                    <div class="border-b pb-4">
                        <h3 class="font-bold mb-2">Order Details</h3>
                        <p class="text-sm mb-1"><span class="text-gray-600">Shop:</span> <span id="modalShop"></span></p>
                        <p class="text-sm"><span class="text-gray-600">Items:</span> <span id="modalItems"></span></p>
                    </div>

                    <!-- Delivery Location -->
                    <div class="border-b pb-4">
                        <h3 class="font-bold mb-2">Delivery Location</h3>
                        <p class="text-sm" id="modalDeliveryLocation"></p>
                    </div>

                    <!-- Rider Assignment -->
                    <div class="border-b pb-4">
                        <h3 class="font-bold mb-3">Assign Rider</h3>
                        <div class="flex gap-2">
                            <input type="text" id="riderNameInput" placeholder="Rider name" class="input flex-1">
                            <input type="tel" id="riderPhoneInput" placeholder="07XX XXX XXX" class="input flex-1">
                        </div>
                        <button onclick="assignRider()" id="assignBtn" class="btn btn-primary w-full mt-2">
                            ‚úÖ Assign Rider
                        </button>
                        <div id="assignedRiderInfo" class="hidden mt-3 p-3 bg-green-50 rounded-lg">
                            <p class="text-sm font-bold text-green-800">Rider Assigned:</p>
                            <p class="text-sm text-green-700" id="assignedRiderName"></p>
                            <p class="text-xs text-green-600" id="assignedRiderPhone"></p>
                        </div>
                    </div>

                    <!-- Status & Actions -->
                    <div>
                        <h3 class="font-bold mb-3">Order Status</h3>
                        <div class="flex items-center justify-between mb-4">
                            <span id="modalStatus" class="badge"></span>
                            <button onclick="markInTransit()" id="transitBtn" class="btn btn-primary text-sm">
                                üö¥ Mark In Transit
                            </button>
                        </div>

                        <div id="trackingSection" class="hidden mb-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm font-bold text-blue-800 mb-2">üìç Live Tracking Link:</p>
                            <p class="text-xs font-mono bg-white p-2 rounded break-all" id="modalTrackingLink"></p>
                            <button onclick="copyTrackingLinkAdmin()" class="btn btn-secondary w-full mt-2">
                                üìã Copy Link
                            </button>
                        </div>

                        <div class="space-y-2">
                            <button onclick="sendTrackingToClient()" class="btn btn-primary w-full">
                                üì± Send Tracking to Client
                            </button>
                            <button onclick="sendDeliveredToClient()" class="btn btn-success w-full">
                                ‚úÖ Send Delivered Message to Client
                            </button>
                            <a href="#" id="modalRiderLink" class="btn btn-secondary w-full block text-center">
                                üö¥ Open Rider Panel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { CONFIG, getSupabaseClient, showToast, getWhatsAppLink } from './js/config.js';

        // Lightweight access gate
        const urlKey = new URLSearchParams(window.location.search).get('key');
        const storedKey = localStorage.getItem('erdelivery_admin_key');
        if (urlKey && urlKey === CONFIG.access.adminCode) {
            localStorage.setItem('erdelivery_admin_key', urlKey);
        }
        if (!localStorage.getItem('erdelivery_admin_key')) {
            const input = prompt('Enter admin access code');
            if (input !== CONFIG.access.adminCode) {
                alert('Access denied');
                window.location.href = 'index.html';
            } else {
                localStorage.setItem('erdelivery_admin_key', input);
            }
        }

        const supabase = getSupabaseClient();
        let allOrders = [];
        let selectedOrder = null;
        let ordersPollInterval = null;
        let modalOpen = false;
        let isEditingRider = false;

        // Load orders on page load
        loadOrders();

        // Subscribe to real-time updates
        supabase
            .channel('orders-channel')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'orders' },
                (payload) => {
                    console.log('Order updated:', payload);
                    loadOrders();
                    showToast('Orders updated', 'success');
                }
            )
            .subscribe();

        async function loadOrders() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allOrders = data;
                updateStats();
                filterOrders();

                // If modal is open, refresh its contents with the latest order
                if (modalOpen && selectedOrder && !isEditingRider) {
                    const updated = allOrders.find(o => o.id === selectedOrder.id);
                    if (updated) {
                        openOrderModal(updated);
                    }
                }

            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('Error loading orders', 'error');
            }
        }

        function updateStats() {
            document.getElementById('totalOrders').textContent = allOrders.length;
            document.getElementById('pendingOrders').textContent = 
                allOrders.filter(o => o.status === 'pending').length;
            document.getElementById('activeOrders').textContent = 
                allOrders.filter(o => ['assigned', 'on_route', 'picked_up'].includes(o.status)).length;
            document.getElementById('deliveredOrders').textContent = 
                allOrders.filter(o => o.status === 'delivered').length;
        }

        window.filterOrders = function() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = [...allOrders];

            // Apply search
            if (search) {
                filtered = filtered.filter(o => 
                    o.order_id.toLowerCase().includes(search) ||
                    o.client_name.toLowerCase().includes(search)
                );
            }

            // Apply status filter
            if (statusFilter) {
                filtered = filtered.filter(o => o.status === statusFilter);
            }

            // Apply sorting
            if (sortBy === 'oldest') {
                filtered.reverse();
            }

            renderOrders(filtered);
        };

        function renderOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            
            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                            No orders found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick='openOrderModal(${JSON.stringify(order)})'>
                    <td class="px-4 py-3 font-mono text-sm font-medium">${order.order_id}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="font-medium">${order.client_name}</div>
                        <div class="text-xs text-gray-500">${order.client_whatsapp}</div>
                    </td>
                    <td class="px-4 py-3 text-sm max-w-xs truncate">${order.order_desc}</td>
                    <td class="px-4 py-3 text-sm max-w-xs truncate">${order.delivery_location_text}</td>
                    <td class="px-4 py-3">
                        <span class="badge badge-${order.status}">${order.status.replace('_', ' ').toUpperCase()}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">
                        ${new Date(order.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-4 py-3">
                        <button onclick='event.stopPropagation(); openOrderModal(${JSON.stringify(order)})' 
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            View
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.openOrderModal = function(order) {
            selectedOrder = order;
            modalOpen = true;
            
            document.getElementById('modalOrderId').textContent = order.order_id;
            document.getElementById('modalOrderDate').textContent = new Date(order.created_at).toLocaleString();
            document.getElementById('modalClientName').textContent = order.client_name;
            document.getElementById('modalClientPhone').textContent = order.client_whatsapp;
            document.getElementById('modalClientPhone').href = `tel:${order.client_whatsapp}`;
            document.getElementById('modalShop').textContent = order.preferred_shop || 'Not specified';
            document.getElementById('modalItems').textContent = order.order_desc;
            document.getElementById('modalDeliveryLocation').textContent = order.delivery_location_text;

            const statusBadge = document.getElementById('modalStatus');
            statusBadge.textContent = order.status.replace('_', ' ').toUpperCase();
            statusBadge.className = `badge badge-${order.status}`;

            document.getElementById('modalRiderLink').href = `rider.html?order=${order.order_id}`;

            // Show rider info if assigned
            if (order.rider_name) {
                document.getElementById('assignedRiderInfo').classList.remove('hidden');
                document.getElementById('assignedRiderName').textContent = order.rider_name;
                document.getElementById('assignedRiderPhone').textContent = order.rider_whatsapp;
                document.getElementById('riderNameInput').value = order.rider_name;
                document.getElementById('riderPhoneInput').value = order.rider_whatsapp;
            } else {
                document.getElementById('assignedRiderInfo').classList.add('hidden');
                document.getElementById('riderNameInput').value = '';
                document.getElementById('riderPhoneInput').value = '';
            }

            // Attach edit listeners once to prevent clearing while typing
            const nameEl = document.getElementById('riderNameInput');
            const phoneEl = document.getElementById('riderPhoneInput');
            if (!nameEl.dataset.bound) {
                const onFocus = () => { isEditingRider = true; if (ordersPollInterval) { clearInterval(ordersPollInterval); ordersPollInterval = null; } };
                const onBlur = () => {
                    // small delay to allow switching between inputs
                    setTimeout(() => {
                        const active = document.activeElement;
                        if (active !== nameEl && active !== phoneEl) {
                            isEditingRider = false;
                            if (!ordersPollInterval) ordersPollInterval = setInterval(loadOrders, 5000);
                        }
                    }, 100);
                };
                nameEl.addEventListener('focus', onFocus);
                phoneEl.addEventListener('focus', onFocus);
                nameEl.addEventListener('blur', onBlur);
                phoneEl.addEventListener('blur', onBlur);
                nameEl.dataset.bound = '1';
                phoneEl.dataset.bound = '1';
            }

            // Show tracking link if available
            if (order.google_maps_link || order.tracking_link) {
                document.getElementById('trackingSection').classList.remove('hidden');
                document.getElementById('modalTrackingLink').textContent = order.google_maps_link || order.tracking_link;
            } else {
                document.getElementById('trackingSection').classList.add('hidden');
            }

            document.getElementById('orderModal').classList.remove('hidden');
        };

        window.closeModal = function() {
            document.getElementById('orderModal').classList.add('hidden');
            modalOpen = false;
        };

        window.assignRider = async function() {
            if (!selectedOrder) return;

            const riderName = document.getElementById('riderNameInput').value.trim();
            const riderPhone = document.getElementById('riderPhoneInput').value.trim();

            if (!riderName || !riderPhone) {
                showToast('Please enter rider name and phone', 'error');
                return;
            }

            try {
                // Disable button to prevent double submits
                const btn = document.getElementById('assignBtn');
                if (btn) btn.disabled = true;

                // Secure update via Edge Function
                let ok = false;
                try {
                    const resp = await fetch(`${CONFIG.supabase.url}/functions/v1/update-order`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            order_id: selectedOrder.id,
                            update: {
                                rider_name: riderName,
                                rider_whatsapp: riderPhone,
                                status: 'assigned'
                            }
                        })
                    })
                    if (!resp.ok) {
                        const r = await resp.json().catch(() => ({}));
                        throw new Error(r.error || 'Failed to assign rider');
                    }
                    ok = true;
                } catch (e) {
                    // Fallback attempt (may be blocked by RLS in prod)
                    try {
                        const { error: fbError } = await supabase
                            .from('orders')
                            .update({ rider_name: riderName, rider_whatsapp: riderPhone, status: 'assigned' })
                            .eq('id', selectedOrder.id);
                        if (fbError) throw fbError;
                        ok = true;
                    } catch (fb) {
                        throw e;
                    }
                } finally {
                    if (btn) btn.disabled = false;
                }

                showToast('Rider assigned successfully!', 'success');
                
                // Show assigned info
                document.getElementById('assignedRiderInfo').classList.remove('hidden');
                document.getElementById('assignedRiderName').textContent = riderName;
                document.getElementById('assignedRiderPhone').textContent = riderPhone;

                // Update selected order
                selectedOrder.rider_name = riderName;
                selectedOrder.rider_whatsapp = riderPhone;
                selectedOrder.status = 'assigned';

                // Reload orders
                setTimeout(() => loadOrders(), 500);

            } catch (error) {
                console.error(error);
                showToast('Error assigning rider: ' + (error.message || 'Network error'), 'error');
            }
        };

        window.markInTransit = async function() {
            if (!selectedOrder) return;

            if (!selectedOrder.rider_name) {
                showToast('Please assign a rider first', 'error');
                return;
            }

            try {
                const btn = document.getElementById('transitBtn');
                if (btn) btn.disabled = true;

                // Secure update via Edge Function
                let ok = false;
                try {
                    const resp = await fetch(`${CONFIG.supabase.url}/functions/v1/update-order`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            order_id: selectedOrder.id,
                            update: { status: 'on_route' }
                        })
                    })
                    if (!resp.ok) {
                        const r = await resp.json().catch(() => ({}))
                        throw new Error(r.error || 'Failed to update status')
                    }
                    ok = true;
                } catch (e) {
                    // Fallback attempt (may be blocked by RLS)
                    try {
                        const { error: fbError } = await supabase
                            .from('orders')
                            .update({ status: 'on_route' })
                            .eq('id', selectedOrder.id);
                        if (fbError) throw fbError;
                        ok = true;
                    } catch (fb) {
                        throw e;
                    }
                } finally {
                    if (btn) btn.disabled = false;
                }

                showToast('Order marked as in transit!', 'success');
                selectedOrder.status = 'on_route';

                // Update status badge
                const statusBadge = document.getElementById('modalStatus');
                statusBadge.textContent = 'ON ROUTE';
                statusBadge.className = 'badge badge-on_route';

                // Reload orders
                setTimeout(() => loadOrders(), 500);

            } catch (error) {
                console.error(error);
                showToast('Error updating status: ' + (error.message || 'Network error'), 'error');
            }
        };

        window.copyTrackingLinkAdmin = function() {
            if (!selectedOrder) return;
            const link = `${window.location.origin}/track.html?order=${selectedOrder.order_id}`;
            navigator.clipboard.writeText(link);
            showToast('Tracking link copied!', 'success');
        };

        window.sendTrackingToClient = async function() {
            if (!selectedOrder) return;

            const link = `${window.location.origin}/track.html?order=${selectedOrder.order_id}`;
            const message = `üö¥ eRdelivery Tracking\n\nHi ${selectedOrder.client_name},\nYour order ${selectedOrder.order_id} is on the way.\nTrack live: ${link}\n\nReply here if you have any questions.`;

            // Try Edge Function
            try {
                const response = await fetch(
                    `${CONFIG.supabase.url}/functions/v1/notify-client`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            order_id: selectedOrder.id,
                            message_type: 'tracking'
                        })
                    }
                );

                const result = await response.json();
                
                if (result.fallback || !result.success) {
                    const waLink = getWhatsAppLink(selectedOrder.client_whatsapp, message);
                    window.open(waLink, '_blank');
                } else {
                    showToast('WhatsApp sent!', 'success');
                }
            } catch (error) {
                const waLink = getWhatsAppLink(selectedOrder.client_whatsapp, message);
                window.open(waLink, '_blank');
            }
        };

        window.sendDeliveredToClient = async function() {
            if (!selectedOrder) return;

            const message = `‚úÖ Delivered\n\nHi ${selectedOrder.client_name},\nYour order ${selectedOrder.order_id} has been delivered.\nThanks for shopping with eRdelivery. Enjoy! üéâ`;

            try {
                const response = await fetch(
                    `${CONFIG.supabase.url}/functions/v1/notify-client`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            order_id: selectedOrder.id,
                            message_type: 'delivered'
                        })
                    }
                );

                const result = await response.json();
                if (result.fallback || !result.success) {
                    const waLink = getWhatsAppLink(selectedOrder.client_whatsapp, message);
                    window.open(waLink, '_blank');
                } else {
                    showToast('Delivered message sent!', 'success');
                }
            } catch (error) {
                const waLink = getWhatsAppLink(selectedOrder.client_whatsapp, message);
                window.open(waLink, '_blank');
            }
        };

        window.refreshOrders = loadOrders;

        // Start polling fallback every 5s to ensure admin stays in sync if realtime hiccups
        if (ordersPollInterval) clearInterval(ordersPollInterval);
        ordersPollInterval = setInterval(loadOrders, 5000);

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
