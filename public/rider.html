<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Panel - eRdelivery</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="assets/logo.svg" alt="eRdelivery" class="h-10 mr-4">
                    <span class="font-bold text-gray-700">Rider Panel</span>
                </div>
                <div id="riderName" class="text-sm font-medium text-gray-600"></div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        
        <!-- Order ID Input -->
        <div class="card mb-8">
            <h1 class="text-2xl font-bold mb-4">Enter Order ID</h1>
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                <input type="text" id="orderIdInput" placeholder="e.g., ER-2025-001" class="input w-full sm:flex-1">
                <button onclick="loadOrder()" class="btn btn-primary w-full sm:w-auto">Load Order</button>
            </div>
        </div>

        <!-- Order Details -->
        <div id="orderSection" class="hidden space-y-6">
            
            <!-- Current Status -->
            <div class="card bg-blue-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold">Order <span id="displayOrderId"></span></h2>
                        <p class="text-sm text-gray-600">Client: <span id="clientName"></span></p>
                    </div>
                    <span id="currentStatus" class="badge"></span>
                </div>
            </div>

            <!-- Delivery Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="font-bold mb-3">üì¶ Items</h3>
                    <p class="text-sm mb-2" id="orderItems"></p>
                    <p class="text-xs text-gray-600">Shop: <span id="shopName"></span></p>
                </div>

                <div class="card">
                    <h3 class="font-bold mb-3">üìç Delivery To</h3>
                    <p class="text-sm mb-2" id="deliveryAddress"></p>
                    <p class="text-xs text-gray-600">Contact: <span id="deliveryContact"></span></p>
                    <a href="#" id="callClientBtn" class="btn btn-secondary w-full mt-3">üìû Call Client</a>
                </div>
            </div>

            <!-- GPS & Tracking -->
            <div class="card bg-green-50">
                <h3 class="font-bold text-lg mb-4">üó∫Ô∏è Generate Tracking Link</h3>
                <p class="text-sm text-gray-700 mb-4">
                    Click below to get your current location and create a tracking link for the client.
                </p>
                
                <div id="gpsStatus" class="mb-4 p-3 bg-white rounded-lg text-sm">
                    <p class="text-gray-600">üìç Waiting for GPS...</p>
                </div>

                <button onclick="generateTrackingLink()" id="generateBtn" class="btn btn-success w-full mb-3">
                    Generate eR Tracking Link
                </button>

                <div id="trackingLinkGenerated" class="hidden">
                    <div class="bg-white p-4 rounded-lg mb-3">
                        <p class="text-xs text-gray-600 mb-2">Tracking Link:</p>
                        <p class="text-sm font-mono bg-gray-100 p-2 rounded break-all" id="generatedLink"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="copyTrackingLink()" class="btn btn-secondary">üìã Copy Link</button>
                        <button onclick="sendToClient()" class="btn btn-primary">üì± Send to Client</button>
                    </div>
                </div>
            </div>

            <!-- Status Update -->
            <div class="card">
                <h3 class="font-bold text-lg mb-4">Update Order Status</h3>
                <div class="space-y-3">
                    <button onclick="acceptOrderWithGPS()" class="btn btn-primary w-full" id="acceptBtn">
                        ‚úÖ Accept Order (Auto GPS)
                    </button>
                    <button onclick="updateStatus('on_route')" class="btn btn-primary w-full hidden" id="pickupBtn">
                        üì¶ Mark as Picked Up
                    </button>
                    <button onclick="updateStatus('delivered')" class="btn btn-success w-full hidden" id="deliverBtn">
                        üéâ Mark as Delivered
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { CONFIG, getSupabaseClient, showToast, getWhatsAppLink } from './js/config.js';

        const supabase = getSupabaseClient();
        let currentOrder = null;
        let currentPosition = null;

        // Check URL for order ID
        const urlParams = new URLSearchParams(window.location.search);
        const orderIdFromUrl = urlParams.get('order');
        if (orderIdFromUrl) {
            document.getElementById('orderIdInput').value = orderIdFromUrl;
            loadOrder();
        }

        window.loadOrder = async function() {
            const orderId = document.getElementById('orderIdInput').value.trim();
            if (!orderId) {
                showToast('Please enter an order ID', 'error');
                return;
            }

            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('order_id', orderId)
                    .single();

                if (error || !order) {
                    throw new Error('Order not found');
                }

                currentOrder = order;
                displayOrder(order);
                document.getElementById('orderSection').classList.remove('hidden');
                showToast('Order loaded successfully', 'success');

            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        };

        function displayOrder(order) {
            document.getElementById('displayOrderId').textContent = order.order_id;
            document.getElementById('clientName').textContent = order.client_name;
            document.getElementById('orderItems').textContent = order.order_desc;
            document.getElementById('shopName').textContent = order.preferred_shop || 'Not specified';
            document.getElementById('deliveryAddress').textContent = order.delivery_location_text;
            document.getElementById('deliveryContact').textContent = order.client_whatsapp;
            document.getElementById('callClientBtn').href = `tel:${order.client_whatsapp}`;

            // Status badge
            const statusBadge = document.getElementById('currentStatus');
            statusBadge.textContent = order.status.replace('_', ' ').toUpperCase();
            statusBadge.className = `badge badge-${order.status}`;

            // Show appropriate buttons
            document.querySelectorAll('[id$="Btn"]').forEach(btn => {
                if (!btn.id.includes('call') && !btn.id.includes('generate')) {
                    btn.classList.add('hidden');
                }
            });

            if (order.status === 'pending') {
                document.getElementById('acceptBtn').classList.remove('hidden');
            } else if (order.status === 'assigned') {
                document.getElementById('pickupBtn').classList.remove('hidden');
            } else if (order.status === 'on_route') {
                document.getElementById('deliverBtn').classList.remove('hidden');
            }

            // Show tracking link if exists
            if (order.tracking_link) {
                document.getElementById('trackingLinkGenerated').classList.remove('hidden');
                document.getElementById('generatedLink').textContent = order.tracking_link;
            }
        }

        window.acceptOrderWithGPS = async function() {
            if (!currentOrder) {
                showToast('No order loaded', 'error');
                return;
            }

            const gpsStatus = document.getElementById('gpsStatus');
            gpsStatus.innerHTML = '<p class="text-blue-600">üìç Getting your location automatically...</p>';

            try {
                // Get current position
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });

                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                gpsStatus.innerHTML = `<p class="text-green-600">‚úÖ Location captured: ${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}</p>`;

                // Generate BRANDED eRiders tracking link
                const brandedTrackingLink = `${window.location.origin}/live-track.html?lat=${currentPosition.lat}&lng=${currentPosition.lng}&order=${currentOrder.order_id}&rider=${encodeURIComponent(currentOrder.rider_name || 'Your Rider')}&phone=${currentOrder.rider_whatsapp || ''}`;
                
                const googleMapsLink = `https://www.google.com/maps?q=${currentPosition.lat},${currentPosition.lng}`;

                // Secure update via Edge Function (bypasses RLS)
                const resp = await fetch(`${CONFIG.supabase.url}/functions/v1/update-order`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: currentOrder.id,
                        update: {
                            rider_lat: currentPosition.lat,
                            rider_lng: currentPosition.lng,
                            tracking_link: brandedTrackingLink,
                            google_maps_link: googleMapsLink,
                            status: 'on_route'
                        }
                    })
                })
                if (!resp.ok) {
                    const r = await resp.json().catch(() => ({}))
                    throw new Error(r.error || 'Failed to update order')
                }

                // Show tracking link
                document.getElementById('generatedLink').textContent = brandedTrackingLink;
                document.getElementById('trackingLinkGenerated').classList.remove('hidden');

                // Show next button
                document.getElementById('acceptBtn').classList.add('hidden');
                document.getElementById('pickupBtn').classList.add('hidden');
                document.getElementById('deliverBtn').classList.remove('hidden');

                showToast('Order accepted! GPS captured & admin notified!', 'success');

                // Send tracking link to admin via WhatsApp
                const adminMessage = `üö¥ *eRdelivery Live Tracking*\n\nOrder: *${currentOrder.order_id}*\nRider location captured!\n\nüìç *Branded Tracking Link:*\n${brandedTrackingLink}\n\n_Forward this link to client for real-time tracking with eRdelivery branding!_`;
                const waLink = getWhatsAppLink(CONFIG.admin.whatsapp, adminMessage);
                
                // Auto-open WhatsApp to admin
                setTimeout(() => {
                    window.open(waLink, '_blank');
                }, 1000);

            } catch (error) {
                console.error('GPS error:', error);
                gpsStatus.innerHTML = '<p class="text-red-600">‚ùå Could not get location. Please enable GPS.</p>';
                showToast('GPS error: ' + error.message, 'error');
            }
        };

        window.generateTrackingLink = async function() {
            if (!currentOrder) {
                showToast('No order loaded', 'error');
                return;
            }

            const gpsStatus = document.getElementById('gpsStatus');
            gpsStatus.innerHTML = '<p class="text-blue-600">üìç Getting your location...</p>';

            try {
                // Get current position
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });

                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                gpsStatus.innerHTML = `<p class="text-green-600">‚úÖ Location found: ${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}</p>`;

                // Generate BRANDED eRiders tracking link
                const brandedTrackingLink = `${window.location.origin}/live-track.html?lat=${currentPosition.lat}&lng=${currentPosition.lng}&order=${currentOrder.order_id}&rider=${encodeURIComponent(currentOrder.rider_name || 'Your Rider')}&phone=${currentOrder.rider_whatsapp || ''}`;
                const googleMapsLink = `https://www.google.com/maps?q=${currentPosition.lat},${currentPosition.lng}`;

                // Secure update via Edge Function
                const resp = await fetch(`${CONFIG.supabase.url}/functions/v1/update-order`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: currentOrder.id,
                        update: {
                            rider_lat: currentPosition.lat,
                            rider_lng: currentPosition.lng,
                            tracking_link: brandedTrackingLink,
                            google_maps_link: googleMapsLink,
                            status: currentOrder.status === 'assigned' ? 'on_route' : currentOrder.status
                        }
                    })
                })
                if (!resp.ok) {
                    const r = await resp.json().catch(() => ({}))
                    throw new Error(r.error || 'Failed to update order')
                }

                // Show tracking link
                document.getElementById('generatedLink').textContent = brandedTrackingLink;
                document.getElementById('trackingLinkGenerated').classList.remove('hidden');

                showToast('Tracking link generated!', 'success');

            } catch (error) {
                console.error('GPS error:', error);
                gpsStatus.innerHTML = '<p class="text-red-600">‚ùå Could not get location. Please enable GPS.</p>';
                showToast('GPS error: ' + error.message, 'error');
            }
        };

        window.copyTrackingLink = function() {
            const link = document.getElementById('generatedLink').textContent;
            navigator.clipboard.writeText(link);
            showToast('Link copied to clipboard!', 'success');
        };

        window.sendToClient = async function() {
            const link = document.getElementById('generatedLink').textContent;
            const message = `üö¥ eRdelivery Tracking\n\nHi ${currentOrder.client_name},\nYour order ${currentOrder.order_id} is on the way.\nTrack live: ${link}\n\nReply here if you have any questions.`;
            
            // Try calling Edge Function
            try {
                const response = await fetch(
                    `${CONFIG.supabase.url}/functions/v1/notify-client`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            order_id: currentOrder.id,
                            message_type: 'tracking'
                        })
                    }
                );

                const result = await response.json();
                
                if (result.fallback || !result.success) {
                    // Open WhatsApp manually
                    const waLink = getWhatsAppLink(currentOrder.client_whatsapp, message);
                    window.open(waLink, '_blank');
                } else {
                    showToast('WhatsApp message sent!', 'success');
                }
            } catch (error) {
                // Fallback to manual WhatsApp
                const waLink = getWhatsAppLink(currentOrder.client_whatsapp, message);
                window.open(waLink, '_blank');
            }
        };

        window.updateStatus = async function(newStatus) {
            if (!currentOrder) return;

            try {
                // Secure update via Edge Function
                const resp = await fetch(`${CONFIG.supabase.url}/functions/v1/update-order`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: currentOrder.id,
                        update: { status: newStatus }
                    })
                })
                if (!resp.ok) {
                    const r = await resp.json().catch(() => ({}))
                    throw new Error(r.error || 'Failed to update order')
                }

                // Notify client
                try {
                    await fetch(
                        `${CONFIG.supabase.url}/functions/v1/notify-client`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                order_id: currentOrder.id,
                                message_type: newStatus === 'delivered' ? 'delivered' : 'tracking'
                            })
                        }
                    );
                } catch (e) {
                    console.warn('WhatsApp notification failed:', e);
                }

                showToast('Status updated!', 'success');
                
                // Reload order
                setTimeout(() => loadOrder(), 1000);

            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        };
    </script>
</body>
</html>
